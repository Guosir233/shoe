<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="/manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹åº—ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #5d5fef;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
            --radius: 8px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f5f5; color: #333; line-height: 1.6; padding-bottom: 80px; }
        .container { max-width: 100%; padding: 0 15px; margin: 0 auto; }
        
        header { 
            background: var(--primary); 
            color: white; 
            padding: 15px 0; 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: var(--shadow); 
        }
        
        h1 { font-size: 1.5rem; font-weight: 600; }
        main { padding: 20px 0; min-height: calc(100vh - 120px); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius);
            background: var(--primary);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: var(--dark); }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(93, 95, 239, 0.2);
        }
        
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 1em;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary);
            text-decoration: none;
            font-size: 0.8rem;
            padding: 5px 10px;
            transition: all 0.3s;
        }
        
        .nav-item i { font-size: 1.2rem; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary); }
        
        .product-card {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .product-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .product-name { font-weight: 600; }
        .product-color {
            padding: 2px 8px;
            border-radius: 12px;
            background: #f0f0f0;
            font-size: 0.8rem;
        }
        
        .product-price {
            font-weight: 600;
            color: var(--primary);
            margin-top: 5px;
        }
        
        .sizes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .size-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 10px;
            background: var(--light);
            border-radius: var(--radius);
            min-width: 50px;
        }
        
        .size-label { font-size: 0.8rem; color: var(--secondary); }
        .size-quantity { font-weight: 600; }
        
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filter-item { flex: 1; min-width: 120px; }
        
        .order-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .order-header {
            background: var(--light);
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .order-info { display: flex; justify-content: space-between; align-items: center; }
        .order-date { font-size: 0.9rem; color: var(--secondary); }
        .order-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: var(--success);
            color: white;
        }
        
        .order-body { padding: 15px; }
        
        .product-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }
        
        .product-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        
        .product-icon {
            width: 40px;
            height: 40px;
            background: var(--light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2rem;
        }
        
        .product-details { flex: 1; }
        .product-title { font-weight: 500; font-size: 0.95rem; }
        .product-meta { font-size: 0.85rem; color: var(--secondary); }
        .product-price { font-weight: 600; color: var(--primary); }
        
        .order-footer {
            border-top: 1px solid #eee;
            padding: 12px 15px;
            background: var(--light);
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-label { font-weight: 600; }
        .total-amount { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        
        .order-actions { display: flex; gap: 10px; }
        .order-actions .btn { flex: 1; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title { font-size: 1.2rem; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
        }
        
        .modal-body { padding: 15px; }
        .modal-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .size-inputs-container {
            margin-bottom: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .size-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .size-input-row input { flex: 2; min-width: 80px; }
        .size-input-row .remove-size-btn {
            flex: 0 0 40px;
            width: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-item:last-child { border-bottom: none; }
        .order-item-info { display: flex; flex-direction: column; }
        .order-item-actions { display: flex; align-items: center; gap: 5px; }
        
        .stats-card {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
        }
        
        .stat-item {
            background: var(--light);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
        }
        
        .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 0.9rem; color: var(--secondary); }
        
        .chart-container {
            padding: 20px;
            margin-top: 20px;
        }
        
        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chart-label {
            width: 100px;
            font-size: 0.9rem;
            text-align: right;
            padding-right: 10px;
        }
        
        .chart-value-bar {
            flex: 1;
            height: 25px;
            background: var(--primary);
            border-radius: 4px;
            position: relative;
            transition: width 0.5s ease;
        }
        
        .chart-value-text {
            position: absolute;
            right: 10px;
            color: white;
            font-size: 0.8rem;
            line-height: 25px;
        }
        
        @media (min-width: 768px) {
            .container { max-width: 750px; }
            .product-card { flex-direction: row; justify-content: space-between; align-items: center; }
            .product-info { margin-bottom: 0; width: 40%; }
            .sizes-container { width: 60%; justify-content: flex-end; }
            .stats-card { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>é‹åº—ç®¡ç†ç³»ç»Ÿ</h1>
        </div>
    </header>

    <main class="container">
        <div id="inventory-tab" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">åº“å­˜ç®¡ç†</div>
                    <button id="add-product-btn" class="btn btn-success">æ·»åŠ äº§å“</button>
                </div>
                <div class="filter-container">
                    <div class="filter-item form-group">
                        <label for="filter-brand" class="form-label">å“ç‰Œ</label>
                        <select id="filter-brand" class="form-control">
                            <option value="">å…¨éƒ¨å“ç‰Œ</option>
                        </select>
                    </div>
                    <div class="filter-item form-group">
                        <label for="filter-code" class="form-label">äº§å“ç¼–å·</label>
                        <select id="filter-code" class="form-control" disabled>
                            <option value="">è¯·å…ˆé€‰æ‹©å“ç‰Œ</option>
                        </select>
                    </div>
                </div>
                <div id="inventory-list"></div>
            </div>
        </div>

        <div id="orders-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">è®¢å•ç®¡ç†</div>
                    <button id="add-order-btn" class="btn btn-success">æ–°å»ºè®¢å•</button>
                </div>
                <div class="filter-container">
                    <div class="filter-item form-group">
                        <label for="orders-start-date" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="orders-start-date" class="form-control">
                    </div>
                    <div class="filter-item form-group">
                        <label for="orders-end-date" class="form-label">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="orders-end-date" class="form-control">
                    </div>
                    <div class="filter-item form-group">
                        <label class="form-label">&nbsp;</label>
                        <button id="apply-orders-filter" class="btn">åº”ç”¨ç­›é€‰</button>
                    </div>
                </div>
                <div id="orders-list"></div>
            </div>
        </div>

        <div id="stats-tab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">é”€å”®ç»Ÿè®¡</div>
                </div>
                <div class="filter-container">
                    <div class="filter-item form-group">
                        <label for="stats-start-date" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" id="stats-start-date" class="form-control">
                    </div>
                    <div class="filter-item form-group">
                        <label for="stats-end-date" class="form-label">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" id="stats-end-date" class="form-control">
                    </div>
                    <div class="filter-item form-group">
                        <label class="form-label">&nbsp;</label>
                        <button id="apply-stats-filter" class="btn">åº”ç”¨ç­›é€‰</button>
                    </div>
                </div>
                <div id="stats-container" class="stats-card">
                    <div class="stat-item">
                        <div class="stat-value" id="total-sales">Â¥0</div>
                        <div class="stat-label">æ€»é”€å”®é¢</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">è®¢å•æ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-order-value">Â¥0</div>
                        <div class="stat-label">å¹³å‡è®¢å•é¢</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="inventory-value">Â¥0</div>
                        <div class="stat-label">åº“å­˜ä»·å€¼</div>
                    </div>
                </div>
                <div id="brand-chart" class="chart-container">
                    <div class="chart-title">å“ç‰Œé”€å”®æ’è¡Œ</div>
                    <div id="brand-chart-bars"></div>
                </div>
                <div id="size-chart" class="chart-container">
                    <div class="chart-title">å°ºç é”€å”®åˆ†å¸ƒ</div>
                    <div id="size-chart-bars"></div>
                </div>
            </div>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-tab="inventory-tab">
            <span>ğŸ“¦</span>
            <span>åº“å­˜</span>
        </a>
        <a href="#" class="nav-item" data-tab="orders-tab">
            <span>ğŸ“</span>
            <span>è®¢å•</span>
        </a>
        <a href="#" class="nav-item" data-tab="stats-tab">
            <span>ğŸ“Š</span>
            <span>ç»Ÿè®¡</span>
        </a>
    </nav>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="product-modal-title">æ·»åŠ æ–°äº§å“</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-group">
                        <label for="product-brand" class="form-label">å“ç‰Œ</label>
                        <input type="text" id="product-brand" class="form-control" required placeholder="è¯·è¾“å…¥å“ç‰Œåç§°">
                    </div>
                    <div class="form-group">
                        <label for="product-code" class="form-label">äº§å“ç¼–å·</label>
                        <input type="text" id="product-code" class="form-control" required placeholder="è¯·è¾“å…¥äº§å“ç¼–å·">
                    </div>
                    <div class="form-group">
                        <label for="product-color" class="form-label">é¢œè‰²</label>
                        <input type="text" id="product-color" class="form-control" required placeholder="è¯·è¾“å…¥é¢œè‰²">
                    </div>
                    <div class="form-group">
                        <label for="product-price" class="form-label">ä»·æ ¼</label>
                        <input type="number" id="product-price" class="form-control" required min="0" step="1" placeholder="è¯·è¾“å…¥ä»·æ ¼">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å°ºç åº“å­˜</label>
                        <div id="size-inputs-container"></div>
                        <button type="button" id="add-size-btn" class="btn" style="margin-top: 10px; width: 100%;">+ æ·»åŠ å°ºç </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn modal-close-btn">å–æ¶ˆ</button>
                <button id="save-product-btn" class="btn btn-success">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="order-modal-title">æ–°å»ºè®¢å•</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    <div class="form-group">
                        <label class="form-label">æ·»åŠ å•†å“</label>
                        <div class="filter-container">
                            <div class="filter-item form-group">
                                <select id="order-brand" class="form-control">
                                    <option value="">é€‰æ‹©å“ç‰Œ</option>
                                </select>
                            </div>
                            <div class="filter-item form-group">
                                <select id="order-code" class="form-control" disabled>
                                    <option value="">é€‰æ‹©ç¼–å·</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-container">
                            <div class="filter-item form-group">
                                <select id="order-color" class="form-control" disabled>
                                    <option value="">é€‰æ‹©é¢œè‰²</option>
                                </select>
                            </div>
                            <div class="filter-item form-group">
                                <select id="order-size" class="form-control" disabled>
                                    <option value="">é€‰æ‹©å°ºç </option>
                                </select>
                            </div>
                            <div class="filter-item form-group">
                                <button type="button" id="add-to-order-btn" class="btn" disabled>æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è®¢å•å•†å“</label>
                        <div id="order-items-list"></div>
                    </div>
                    <div class="form-group">
                        <label for="order-amount" class="form-label">æ”¯ä»˜é‡‘é¢</label>
                        <input type="number" id="order-amount" class="form-control" required min="0" step="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn modal-close-btn">å–æ¶ˆ</button>
                <button id="save-order-btn" class="btn btn-success">å®Œæˆè®¢å•</button>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('load', async e => {
            if ('serviceWorker' in navigator) {
                try {
                    navigator.serviceWorker.register('/sw.js');
                    console.log('SW registered');

                } catch (error) {
                    console.log('SW failed');

                }
            }
        });
        // æ•°æ®ç®¡ç†ç±»
        class DataManager {
            constructor() {
                this.products = this.loadFromStorage('products') || [];
                this.orders = this.loadFromStorage('orders') || [];
            }

            loadFromStorage(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }

            saveToStorage(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            saveProducts() {
                this.saveToStorage('products', this.products);
            }

            saveOrders() {
                this.saveToStorage('orders', this.orders);
            }

            getNextProductId() {
                return this.products.length > 0 ? Math.max(...this.products.map(p => p.id)) + 1 : 1;
            }

            getNextOrderId() {
                return this.orders.length > 0 ? Math.max(...this.orders.map(o => o.id)) + 1 : 1;
            }

            getAllBrands() {
                return [...new Set(this.products.map(p => p.brand))].sort();
            }

            getProductsByBrand(brand) {
                return this.products.filter(p => p.brand === brand);
            }

            getProductById(id) {
                return this.products.find(p => p.id === id);
            }

            getOrderById(id) {
                return this.orders.find(o => o.id === id);
            }

            addProduct(product) {
                this.products.push(product);
                this.saveProducts();
            }

            updateProduct(id, updatedProduct) {
                const index = this.products.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.products[index] = { ...this.products[index], ...updatedProduct };
                    this.saveProducts();
                }
            }

            deleteProduct(id) {
                const index = this.products.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.products.splice(index, 1);
                    this.saveProducts();
                }
            }

            addOrder(order) {
                this.orders.push(order);
                this.saveOrders();
            }

            updateOrder(id, updatedOrder) {
                const index = this.orders.findIndex(o => o.id === id);
                if (index !== -1) {
                    this.orders[index] = { ...this.orders[index], ...updatedOrder };
                    this.saveOrders();
                }
            }

            deleteOrder(id) {
                const index = this.orders.findIndex(o => o.id === id);
                if (index !== -1) {
                    this.orders.splice(index, 1);
                    this.saveOrders();
                }
            }
        }

        // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
        const dataManager = new DataManager();

        // DOMå…ƒç´ 
        const $ = id => document.getElementById(id);
        const $$ = selector => document.querySelectorAll(selector);

        let currentProductId = null;
        let currentOrderId = null;
        let orderItems = [];
        let originalOrderItems = [];

        // é€šç”¨å‡½æ•°
        function createElement(tag, className, innerHTML = '') {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (innerHTML) element.innerHTML = innerHTML;
            return element;
        }

        function showModal(modalId) {
            $(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            $(modalId).style.display = 'none';
        }

        function filterProducts(brandFilter, codeFilter) {
            let filtered = [...dataManager.products];
            if (brandFilter) filtered = filtered.filter(p => p.brand === brandFilter);
            if (codeFilter) filtered = filtered.filter(p => p.code === codeFilter);
            return filtered;
        }

        function renderSelect(selectElement, options, defaultOption) {
            selectElement.innerHTML = `<option value="">${defaultOption}</option>`;
            options.forEach(option => {
                selectElement.innerHTML += `<option value="${option}">${option}</option>`;
            });
        }

        // æ›´æ–°å“ç‰Œé€‰æ‹©æ¡†
        function updateBrandSelects() {
            const brands = dataManager.getAllBrands();
            renderSelect($('filter-brand'), brands, 'å…¨éƒ¨å“ç‰Œ');
            renderSelect($('order-brand'), brands, 'é€‰æ‹©å“ç‰Œ');
        }

        // æ—¥æœŸç­›é€‰å‡½æ•°
        function filterByDateRange(items, startDate, endDate, dateField = 'date') {
            if (!startDate && !endDate) return items;
            
            const start = startDate ? new Date(startDate).setHours(0, 0, 0, 0) : null;
            const end = endDate ? new Date(endDate).setHours(23, 59, 59, 999) : null;
            
            return items.filter(item => {
                const itemDate = new Date(item[dateField]).getTime();
                if (start && end) return itemDate >= start && itemDate <= end;
                if (start) return itemDate >= start;
                if (end) return itemDate <= end;
                return true;
            });
        }

        // åº“å­˜ç®¡ç†å‡½æ•°
        function updateInventory(productId, size, quantity) {
            const product = dataManager.getProductById(productId);
            if (product && product.sizes[size] !== undefined) {
                product.sizes[size] = Math.max(0, product.sizes[size] + quantity);
                dataManager.updateProduct(productId, product);
            }
        }

        function restoreInventory(items) {
            items.forEach(item => {
                updateInventory(item.productId, item.size, 1);
            });
        }

        function deductInventory(items) {
            items.forEach(item => {
                updateInventory(item.productId, item.size, -1);
            });
        }

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        function calculateStats(startDate, endDate) {
            const filteredOrders = filterByDateRange(dataManager.orders, startDate, endDate);
            const totalSales = filteredOrders.reduce((sum, order) => sum + order.amount, 0);
            const totalOrders = filteredOrders.length;
            const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;
            
            // å“ç‰Œé”€å”®ç»Ÿè®¡
            const brandSales = {};
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    brandSales[item.brand] = (brandSales[item.brand] || 0) + item.price;
                });
            });
            
            // å°ºç é”€å”®ç»Ÿè®¡
            const sizeSales = {};
            filteredOrders.forEach(order => {
                order.items.forEach(item => {
                    sizeSales[item.size] = (sizeSales[item.size] || 0) + 1;
                });
            });
            
            // è®¡ç®—åº“å­˜ä»·å€¼
            const inventoryValue = dataManager.products.reduce((sum, product) => {
                const totalQuantity = Object.values(product.sizes).reduce((a, b) => a + b, 0);
                return sum + (totalQuantity * product.price);
            }, 0);
            
            return { totalSales, totalOrders, avgOrderValue, inventoryValue, brandSales, sizeSales };
        }

        // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
        function renderStats(startDate, endDate) {
            const stats = calculateStats(startDate, endDate);
            $('total-sales').textContent = `Â¥${stats.totalSales}`;
            $('total-orders').textContent = stats.totalOrders;
            $('avg-order-value').textContent = `Â¥${Math.round(stats.avgOrderValue)}`;
            $('inventory-value').textContent = `Â¥${stats.inventoryValue}`;
            
            // æ¸²æŸ“å“ç‰Œé”€å”®æ’è¡Œå›¾è¡¨
            renderChart('brand-chart-bars', stats.brandSales);
            
            // æ¸²æŸ“å°ºç é”€å”®åˆ†å¸ƒå›¾è¡¨
            renderChart('size-chart-bars', stats.sizeSales);
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(containerId, data) {
            const container = $(containerId);
            container.innerHTML = '';
            
            const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
            const maxValue = Math.max(...Object.values(data));
            
            sortedData.forEach(([label, value]) => {
                const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                const bar = createElement('div', 'chart-bar');
                bar.innerHTML = `
                    <div class="chart-label">${label}</div>
                    <div class="chart-value-bar" style="width: ${percentage}%">
                        <div class="chart-value-text">${containerId.includes('brand') ? `Â¥${value}` : value}</div>
                    </div>
                `;
                container.appendChild(bar);
            });
        }

        // æ¸²æŸ“åº“å­˜åˆ—è¡¨
        function renderInventoryList() {
            const filteredProducts = filterProducts($('filter-brand').value, $('filter-code').value);
            const inventoryList = $('inventory-list');
            inventoryList.innerHTML = '';

            if (filteredProducts.length === 0) {
                inventoryList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--secondary);">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„äº§å“</div>';
                return;
            }

            filteredProducts.forEach(product => {
                const card = createElement('div', 'product-card');
                
                const info = createElement('div', 'product-info', `
                    <div>
                        <div class="product-name">${product.brand} - ${product.code}</div>
                        <span class="product-color">${product.color}</span>
                        <div class="product-price">Â¥${product.price}</div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-warning edit-product-btn" data-id="${product.id}">ç¼–è¾‘</button>
                        <button class="btn btn-sm btn-danger delete-product-btn" data-id="${product.id}">åˆ é™¤</button>
                    </div>
                `);

                const sizes = createElement('div', 'sizes-container');
                Object.entries(product.sizes).forEach(([size, quantity]) => {
                    sizes.innerHTML += `
                        <div class="size-item">
                            <span class="size-label">${size}</span>
                            <span class="size-quantity">${quantity}</span>
                        </div>
                    `;
                });

                card.appendChild(info);
                card.appendChild(sizes);
                inventoryList.appendChild(card);

                card.querySelector('.edit-product-btn').addEventListener('click', () => editProduct(product.id));
                card.querySelector('.delete-product-btn').addEventListener('click', () => deleteProduct(product.id));
            });
        }

        // æ¸²æŸ“è®¢å•åˆ—è¡¨
        function renderOrdersList(startDate, endDate) {
            const filteredOrders = filterByDateRange(dataManager.orders, startDate, endDate);
            const ordersList = $('orders-list');
            ordersList.innerHTML = '';

            if (filteredOrders.length === 0) {
                ordersList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--secondary);">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®¢å•</div>';
                return;
            }

            filteredOrders.forEach(order => {
                const card = createElement('div', 'order-card');
                
                let productsHTML = '';
                order.items.forEach(item => {
                    productsHTML += `
                        <div class="product-item">
                            <div class="product-icon">ğŸ‘Ÿ</div>
                            <div class="product-details">
                                <div class="product-title">${item.brand} - ${item.code}</div>
                                <div class="product-meta">${item.color} / ${item.size}ç </div>
                            </div>
                            <div class="product-price">Â¥${item.price}</div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="order-header">
                        <div class="order-info">
                            <span class="order-date">${order.date}</span>
                            <span class="order-status">å·²å®Œæˆ</span>
                        </div>
                    </div>
                    <div class="order-body">${productsHTML}</div>
                    <div class="order-footer">
                        <div class="order-total">
                            <span class="total-label">æ€»è®¡</span>
                            <span class="total-amount">Â¥${order.amount}</span>
                        </div>
                        <div class="order-actions">
                            <button class="btn btn-warning edit-order-btn" data-id="${order.id}">ç¼–è¾‘</button>
                            <button class="btn btn-danger delete-order-btn" data-id="${order.id}">åˆ é™¤</button>
                        </div>
                    </div>
                `;

                ordersList.appendChild(card);
                card.querySelector('.edit-order-btn').addEventListener('click', () => editOrder(order.id));
                card.querySelector('.delete-order-btn').addEventListener('click', () => deleteOrder(order.id));
            });
        }

        // æ·»åŠ å°ºç è¡Œ
        function addSizeRow(size = '', quantity = 0) {
            const row = createElement('div', 'size-input-row');
            row.innerHTML = `
                <input type="text" class="form-control size-input" placeholder="å°ºç " value="${size}">
                <input type="number" class="form-control quantity-input" placeholder="åº“å­˜" min="0" value="${quantity}">
                <button class="btn btn-danger remove-size-btn">Ã—</button>
            `;

            row.querySelector('.remove-size-btn').addEventListener('click', () => {
                row.remove();
                if ($('size-inputs-container').children.length === 0) addSizeRow();
            });

            $('size-inputs-container').appendChild(row);
        }

        // ç¼–è¾‘äº§å“
        function editProduct(id) {
            const product = dataManager.getProductById(id);
            if (!product) return;

            currentProductId = id;
            $('product-modal-title').textContent = 'ç¼–è¾‘äº§å“';
            $('product-brand').value = product.brand;
            $('product-code').value = product.code;
            $('product-color').value = product.color;
            $('product-price').value = product.price;

            $('size-inputs-container').innerHTML = '';
            Object.entries(product.sizes).forEach(([size, quantity]) => addSizeRow(size, quantity));
            if ($('size-inputs-container').children.length === 0) addSizeRow();

            showModal('product-modal');
        }

        // åˆ é™¤äº§å“
        function deleteProduct(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿ')) {
                dataManager.deleteProduct(id);
                renderInventoryList();
                updateBrandSelects();
            }
        }

        // ä¿å­˜äº§å“
        function saveProduct() {
            const brand = $('product-brand').value.trim();
            const code = $('product-code').value.trim();
            const color = $('product-color').value.trim();
            const price = parseInt($('product-price').value);

            if (!brand || !code || !color || isNaN(price) || price < 0) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼Œå¹¶ç¡®ä¿ä»·æ ¼æœ‰æ•ˆ');
                return;
            }

            const sizes = {};
            let hasValidSize = false;

            $$('.size-input-row').forEach(row => {
                const size = row.querySelector('.size-input').value.trim();
                const quantity = parseInt(row.querySelector('.quantity-input').value);

                if (size && !isNaN(quantity) && quantity >= 0) {
                    sizes[size] = quantity;
                    hasValidSize = true;
                }
            });

            if (!hasValidSize) {
                alert('è‡³å°‘éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„å°ºç å’Œåº“å­˜æ•°é‡');
                return;
            }

            if (currentProductId) {
                dataManager.updateProduct(currentProductId, { brand, code, color, price, sizes });
            } else {
                const newProduct = {
                    id: dataManager.getNextProductId(),
                    brand,
                    code,
                    color,
                    price,
                    sizes
                };
                dataManager.addProduct(newProduct);
            }

            renderInventoryList();
            updateBrandSelects();
            hideModal('product-modal');
        }

        // ç¼–è¾‘è®¢å•
        function editOrder(id) {
            const order = dataManager.getOrderById(id);
            if (!order) return;

            currentOrderId = id;
            originalOrderItems = [...order.items];
            orderItems = [...order.items];
            $('order-modal-title').textContent = 'ç¼–è¾‘è®¢å•';
            $('order-amount').value = order.amount;

            resetOrderSelectors();
            renderOrderItems();
            showModal('order-modal');
        }

        // åˆ é™¤è®¢å•
        function deleteOrder(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿ')) {
                const order = dataManager.getOrderById(id);
                if (order) {
                    restoreInventory(order.items);
                    dataManager.deleteOrder(id);
                    renderOrdersList();
                    renderInventoryList();
                }
            }
        }

        // ä¿å­˜è®¢å•
        function saveOrder() {
            const amount = parseInt($('order-amount').value);

            if (isNaN(amount) || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ”¯ä»˜é‡‘é¢');
                return;
            }

            if (orderItems.length === 0) {
                alert('è®¢å•ä¸­è‡³å°‘éœ€è¦ä¸€ä»¶å•†å“');
                return;
            }

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            if (currentOrderId) {
                restoreInventory(originalOrderItems);
                deductInventory(orderItems);
                dataManager.updateOrder(currentOrderId, { items: [...orderItems], amount });
            } else {
                deductInventory(orderItems);
                const newOrder = {
                    id: dataManager.getNextOrderId(),
                    date: dateStr,
                    items: [...orderItems],
                    amount
                };
                dataManager.addOrder(newOrder);
            }

            renderOrdersList();
            renderInventoryList();
            renderStats(); // æ›´æ–°ç»Ÿè®¡æ•°æ®
            hideModal('order-modal');
        }

        // æ›´æ–°é€‰æ‹©æ¡†é€‰é¡¹
        function updateSelectOptions(brand = '', code = '', color = '') {
            const filteredProducts = filterProducts(brand, code);
            
            if (brand) {
                const codes = [...new Set(filteredProducts.map(p => p.code))];
                renderSelect($('order-code'), codes, 'é€‰æ‹©ç¼–å·');
                $('order-code').disabled = false;
                $('order-code').value = code;
            } else {
                $('order-code').innerHTML = '<option value="">é€‰æ‹©ç¼–å·</option>';
                $('order-code').disabled = true;
                $('order-code').value = '';
            }

            if (brand && code) {
                const colors = [...new Set(filteredProducts.filter(p => p.code === code).map(p => p.color))];
                renderSelect($('order-color'), colors, 'é€‰æ‹©é¢œè‰²');
                $('order-color').disabled = false;
                $('order-color').value = color;
            } else {
                $('order-color').innerHTML = '<option value="">é€‰æ‹©é¢œè‰²</option>';
                $('order-color').disabled = true;
                $('order-color').value = '';
            }

            if (brand && code && color) {
                const product = dataManager.products.find(p => p.brand === brand && p.code === code && p.color === color);
                if (product) {
                    const sizes = Object.keys(product.sizes).filter(size => product.sizes[size] > 0);
                    renderSelect($('order-size'), sizes, 'é€‰æ‹©å°ºç ');
                    $('order-size').disabled = false;
                    $('add-to-order-btn').disabled = sizes.length === 0;
                } else {
                    $('order-size').innerHTML = '<option value="">é€‰æ‹©å°ºç </option>';
                    $('order-size').disabled = true;
                    $('add-to-order-btn').disabled = true;
                }
            } else {
                $('order-size').innerHTML = '<option value="">é€‰æ‹©å°ºç </option>';
                $('order-size').disabled = true;
                $('add-to-order-btn').disabled = true;
            }
        }

        // æ·»åŠ å•†å“åˆ°è®¢å•
        function addItemToOrder() {
            const brand = $('order-brand').value;
            const code = $('order-code').value;
            const color = $('order-color').value;
            const size = $('order-size').value;

            if (!brand || !code || !color || !size) {
                alert('è¯·é€‰æ‹©å®Œæ•´çš„å•†å“ä¿¡æ¯');
                return;
            }

            const product = dataManager.products.find(p => p.brand === brand && p.code === code && p.color === color);
            if (!product || product.sizes[size] <= 0) {
                alert('åº“å­˜ä¸è¶³');
                return;
            }

            if (orderItems.some(item => item.brand === brand && item.code === code && item.color === color && item.size === size)) {
                alert('è¯¥å•†å“å·²æ·»åŠ åˆ°è®¢å•ä¸­');
                return;
            }

            orderItems.push({ productId: product.id, brand, code, color, size, price: product.price });
            renderOrderItems();
            resetOrderSelectors();
        }

        // æ¸²æŸ“è®¢å•å•†å“åˆ—è¡¨
        function renderOrderItems() {
            const orderItemsList = $('order-items-list');
            orderItemsList.innerHTML = '';

            if (orderItems.length === 0) {
                orderItemsList.innerHTML = '<div style="text-align: center; padding: 10px; color: var(--secondary);">æš‚æ— å•†å“</div>';
                $('order-amount').value = '';
                return;
            }

            let totalAmount = 0;
            orderItems.forEach((item, index) => {
                totalAmount += item.price;
                const itemElement = createElement('div', 'order-item', `
                    <div class="order-item-info">
                        <div>${item.brand} - ${item.code} (${item.color}, ${item.size}ç )</div>
                        <div>Â¥${item.price}</div>
                    </div>
                    <div class="order-item-actions">
                        <button class="btn btn-sm btn-danger remove-item-btn" data-index="${index}">åˆ é™¤</button>
                    </div>
                `);
                orderItemsList.appendChild(itemElement);

                itemElement.querySelector('.remove-item-btn').addEventListener('click', () => {
                    orderItems.splice(index, 1);
                    renderOrderItems();
                });
            });

            $('order-amount').value = totalAmount;
        }

        // é‡ç½®è®¢å•é€‰æ‹©æ¡†
        function resetOrderSelectors() {
            $('order-brand').value = '';
            $('order-code').innerHTML = '<option value="">é€‰æ‹©ç¼–å·</option>';
            $('order-code').disabled = true;
            $('order-code').value = '';
            $('order-color').innerHTML = '<option value="">é€‰æ‹©é¢œè‰²</option>';
            $('order-color').disabled = true;
            $('order-color').value = '';
            $('order-size').innerHTML = '<option value="">é€‰æ‹©å°ºç </option>';
            $('order-size').disabled = true;
            $('order-size').value = '';
            $('add-to-order-btn').disabled = true;
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // å¯¼èˆªåˆ‡æ¢
            $$('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = item.getAttribute('data-tab');
                    $$('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    $$('.tab-content').forEach(content => content.classList.remove('active'));
                    $(tabId).classList.add('active');
                    
                    // åˆ‡æ¢åˆ°ç»Ÿè®¡é¡µé¢æ—¶åˆ·æ–°æ•°æ®
                    if (tabId === 'stats-tab') {
                        renderStats($('stats-start-date').value, $('stats-end-date').value);
                    }
                });
            });

            // å“ç‰Œç­›é€‰
            $('filter-brand').addEventListener('change', () => {
                const brand = $('filter-brand').value;
                if (brand) {
                    const codes = [...new Set(dataManager.products.filter(p => p.brand === brand).map(p => p.code))];
                    renderSelect($('filter-code'), codes, 'å…¨éƒ¨ç¼–å·');
                    $('filter-code').disabled = false;
                } else {
                    $('filter-code').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å“ç‰Œ</option>';
                    $('filter-code').disabled = true;
                }
                renderInventoryList();
            });

            $('filter-code').addEventListener('change', renderInventoryList);

            // è®¢å•ç­›é€‰
            $('apply-orders-filter').addEventListener('click', () => {
                const startDate = $('orders-start-date').value;
                const endDate = $('orders-end-date').value;
                renderOrdersList(startDate, endDate);
            });

            // ç»Ÿè®¡ç­›é€‰
            $('apply-stats-filter').addEventListener('click', () => {
                const startDate = $('stats-start-date').value;
                const endDate = $('stats-end-date').value;
                renderStats(startDate, endDate);
            });

            // æ¨¡æ€æ¡†
            $('add-product-btn').addEventListener('click', () => {
                currentProductId = null;
                $('product-modal-title').textContent = 'æ·»åŠ æ–°äº§å“';
                $('product-form').reset();
                $('size-inputs-container').innerHTML = '';
                addSizeRow();
                showModal('product-modal');
            });

            $('add-order-btn').addEventListener('click', () => {
                currentOrderId = null;
                orderItems = [];
                originalOrderItems = [];
                $('order-modal-title').textContent = 'æ–°å»ºè®¢å•';
                $('order-form').reset();
                $('order-items-list').innerHTML = '';
                updateBrandSelects();
                resetOrderSelectors();
                showModal('order-modal');
            });

            $$('.modal-close, .modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const orderModal = $('order-modal');
                    if (orderModal.style.display === 'flex' && originalOrderItems.length > 0) {
                        const newItems = orderItems.filter(item => 
                            !originalOrderItems.some(orig => 
                                orig.productId === item.productId && 
                                orig.size === item.size &&
                                orig.color === item.color
                            )
                        );
                        restoreInventory(newItems);
                    }
                    
                    hideModal('product-modal');
                    hideModal('order-modal');
                });
            });

            window.addEventListener('click', (e) => {
                if (e.target.id === 'product-modal') hideModal('product-modal');
                if (e.target.id === 'order-modal') hideModal('order-modal');
            });

            // ä¿å­˜æŒ‰é’®
            $('save-product-btn').addEventListener('click', saveProduct);
            $('save-order-btn').addEventListener('click', saveOrder);

            // è®¢å•é€‰æ‹©æ¡†
            $('order-brand').addEventListener('change', () => {
                $('order-code').value = '';
                $('order-color').value = '';
                $('order-size').value = '';
                updateSelectOptions($('order-brand').value);
            });

            $('order-code').addEventListener('change', () => {
                $('order-color').value = '';
                $('order-size').value = '';
                updateSelectOptions($('order-brand').value, $('order-code').value);
            });

            $('order-color').addEventListener('change', () => {
                $('order-size').value = '';
                updateSelectOptions($('order-brand').value, $('order-code').value, $('order-color').value);
            });

            $('add-to-order-btn').addEventListener('click', addItemToOrder);
            $('add-size-btn').addEventListener('click', () => addSizeRow());

            // åˆå§‹åŒ–å“ç‰Œé€‰æ‹©æ¡†
            updateBrandSelects();

            // åˆå§‹åŒ–æ¸²æŸ“
            addSizeRow();
            renderInventoryList();
            renderOrdersList();
            renderStats();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>